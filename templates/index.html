<!doctype html>
<html lang="{{ lang or 'tr' }}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ t.get("title","KaraApp") }}</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --primary:#2563eb;
      --danger:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.06);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 60px;}
    .topbar{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap;}
    h1{margin:0;font-size:40px;line-height:1.1;}
    .subtitle{margin-top:6px;color:var(--muted);font-size:16px;max-width:520px;}
    .right{display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:flex-end;}
    .lang{display:flex;gap:8px;flex-wrap:wrap;}
    .lang a{border:1px solid var(--line);background:var(--card);padding:8px 12px;border-radius:999px;font-weight:700;font-size:14px;}
    .lang a.active{border-color:var(--primary);box-shadow:0 0 0 2px rgba(37,99,235,.12) inset;}
    .btn, .btn-outline{border-radius:999px;padding:9px 14px;font-weight:800;font-size:14px;display:inline-flex;align-items:center;gap:8px;cursor:pointer;border:1px solid var(--line);background:var(--card);}
    .btn{border-color:var(--primary);background:var(--primary);color:#fff;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);}
    .muted{color:var(--muted)}
    .kpis{margin-top:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;}
    .kpi{padding:18px;}
    .kpi .label{color:var(--muted);font-weight:800;font-size:13px;}
    .kpi .val{margin-top:6px;font-weight:900;font-size:34px;letter-spacing:-0.5px;}
    .green{color:#16a34a}
    .two-col{margin-top:18px;display:grid;grid-template-columns:420px 1fr;gap:14px;align-items:start;}
    @media (max-width:980px){.two-col{grid-template-columns:1fr;}}
    .formCard{padding:16px;}
    .formTitle{font-size:18px;font-weight:900;margin:0 0 10px 0;}
    .formGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:520px){.formGrid{grid-template-columns:1fr;}}
    .field label{display:block;font-size:13px;color:var(--muted);font-weight:800;margin-bottom:6px;}
    .inp{width:100%;border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:14px;outline:none;background:#fff;}
    .inp:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.12);}
    .formActions{margin-top:12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .note{margin-top:8px;font-size:13px;color:var(--muted);}
    .charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:14px;}
    .chartCard{padding:16px;}
    .chartTitle{margin:0 0 10px 0;font-size:18px;font-weight:900;}
    .tableCard{margin-top:14px;padding:16px;}
    table{width:100%;border-collapse:collapse;font-size:14px;}
    th,td{padding:10px 10px;border-top:1px solid var(--line);text-align:left;}
    th{border-top:0;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.04em;}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div>
        <h1>{{ t.get("title","KaraApp") }}</h1>
        <div class="subtitle">{{ t.get("subtitle","") }}</div>
        <div style="margin-top:10px; font-weight:900;">
          游녦 {{ t.get("welcome","Ho륺eldin") }}, <span>{{ current_user.username }}</span>
        </div>
      </div>

      <div class="right">
        <div class="lang">
          <a href="{{ url_for('index', lang='tr') }}" class="{{ 'active' if lang=='tr' else '' }}">游좷릖 T칲rk칞e</a>
          <a href="{{ url_for('index', lang='sv') }}" class="{{ 'active' if lang=='sv' else '' }}">游젏릖 Svenska</a>
          <a href="{{ url_for('index', lang='en') }}" class="{{ 'active' if lang=='en' else '' }}">游섫릖 English</a>
        </div>

        {% if current_user.is_admin %}
          <a class="btn-outline" href="{{ url_for('admin_users', lang=lang) }}">
            {{ t.get("admin_users","Kullan캼c캼lar캼 y칬net") }}
          </a>
        {% endif %}

        <a class="btn-outline" href="{{ url_for('logout', lang=lang) }}">{{ t.get("logout","칂캼k캼") }}</a>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="card kpi">
        <div class="label">{{ t.get("total_sales","Toplam sat캼") }}</div>
        <div class="val">{{ total_sales }} {{ currency }}</div>
      </div>
      <div class="card kpi">
        <div class="label">{{ t.get("total_expense","Toplam gider") }}</div>
        <div class="val">{{ total_expense }} {{ currency }}</div>
      </div>
      <div class="card kpi">
        <div class="label">{{ t.get("total_profit","Toplam k칙r") }}</div>
        <div class="val green">{{ total_profit }} {{ currency }}</div>
      </div>
    </div>

    <div class="two-col">
      <!-- New record -->
      <div class="card formCard">
        <h2 class="formTitle">{{ t.get("new_record","Yeni Kay캼t") }}</h2>

        <form method="post" action="{{ url_for('index_post', lang=lang) }}">
          <div class="formGrid">
            <div class="field">
              <label>{{ t.get("date","Tarih") }}</label>
              <input class="inp" type="date" name="day" required>
            </div>

            <div class="field">
              <label>{{ t.get("sales","Sat캼") }} ({{ currency }})</label>
              <input class="inp" type="number" step="0.01" name="sales" required placeholder="{{ t.get('sales','Sat캼') }}">
            </div>

            <div class="field">
              <label>{{ t.get("expense","Gider") }} ({{ currency }})</label>
              <input class="inp" type="number" step="0.01" name="expense" required placeholder="{{ t.get('expense','Gider') }}">
            </div>
          </div>

          <div class="formActions">
            <button class="btn" type="submit">{{ t.get("save","Kaydet") }}</button>
          </div>

          <div class="note">{{ t.get("profit_note","Not: K칙r otomatik = sat캼 - gider") }}</div>
        </form>
      </div>

      <!-- Charts -->
      <div class="charts">
        <div class="card chartCard">
          <h3 class="chartTitle">{{ t.get("daily_chart_title","30 G칲nl칲k Grafik") }}</h3>
          <canvas id="dailyChart"></canvas>
          <div class="note">{{ t.get("profit_note","Not: K칙r otomatik = sat캼 - gider") }}</div>
        </div>

        <div class="card chartCard">
          <h3 class="chartTitle">{{ t.get("monthly_chart_title","Ayl캼k Grafik") }}</h3>
          <canvas id="monthlyChart"></canvas>
          <div class="note">{{ t.get("profit_note","Not: K칙r otomatik = sat캼 - gider") }}</div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card tableCard">
      <h3 style="margin:0 0 10px 0; font-size:18px; font-weight:900;">
        {{ t.get("records_title","Kay캼tlar (son 50)") }}
      </h3>

      <table>
        <thead>
          <tr>
            <th>{{ t.get("date","Tarih") }}</th>
            <th>{{ t.get("sales","Sat캼") }}</th>
            <th>{{ t.get("expense","Gider") }}</th>
            <th>{{ t.get("profit","K칙r") }}</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td>{{ r["day"] }}</td>
            <td>{{ "%.2f"|format(r["sales"]) }} {{ currency }}</td>
            <td>{{ "%.2f"|format(r["expense"]) }} {{ currency }}</td>
            <td>{{ "%.2f"|format(r["profit"]) }} {{ currency }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>

  <script>
    const dailyRows = {{ daily_rows|tojson }};
    const monthlyRows = {{ monthly_rows|tojson }};

    function mkDaily() {
      const labels = dailyRows.map(x => x.day);
      const sales = dailyRows.map(x => x.sales);
      const expense = dailyRows.map(x => x.expense);
      const profit = dailyRows.map(x => x.profit);

      new Chart(document.getElementById("dailyChart"), {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "{{ t.get('sales','Sat캼') }}", data: sales },
            { label: "{{ t.get('expense','Gider') }}", data: expense },
            { label: "{{ t.get('profit','K칙r') }}", data: profit, type: "line" }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
      document.getElementById("dailyChart").parentElement.style.height = "320px";
    }

    function mkMonthly() {
      const labels = monthlyRows.map(x => x.month);
      const sales = monthlyRows.map(x => x.sales);
      const expense = monthlyRows.map(x => x.expense);
      const profit = monthlyRows.map(x => x.profit);

      new Chart(document.getElementById("monthlyChart"), {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "{{ t.get('sales','Sat캼') }}", data: sales },
            { label: "{{ t.get('expense','Gider') }}", data: expense },
            { label: "{{ t.get('profit','K칙r') }}", data: profit, type: "line" }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
      document.getElementById("monthlyChart").parentElement.style.height = "320px";
    }

    mkDaily();
    mkMonthly();
  </script>
</body>
</html>