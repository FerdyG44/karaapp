<!doctype html>
<html lang="{{ lang }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ t.title }}</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f5f7fb;
      --card:#fff;
      --text:#111827;
      --muted:#6b7280;
      --primary:#2563eb;
      --danger:#ef4444;
      --radius:14px;
      --shadow:0 10px 30px rgba(0,0,0,.06);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{max-width:1200px;margin:0 auto;padding:28px}

    .topbar{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:20px;
}

.top-left{max-width:520px;}

.top-right{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:10px;
}

.lang-row{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
}

.pill{
  border:1px solid var(--line);
  background:#fff;
  padding:8px 12px;
  border-radius:999px;
  font-weight:800;
  font-size:14px;
  text-decoration:none;
  color:inherit;
}

.pill.active{
  border-color:var(--primary);
  box-shadow:0 0 0 2px rgba(37,99,235,.12) inset;
}

.actions-grid{
  display:grid;
  grid-template-columns: repeat(2, auto);
  gap:8px;
  justify-content:end;
}

.btn-primary{
  border:1px solid var(--primary);
  background:var(--primary);
  color:#fff;
  padding:10px 12px;
  border-radius:12px;
  font-weight:900;
  text-decoration:none;
  text-align:center;
}

@media (max-width: 900px){
  .topbar{flex-direction:column; align-items:stretch;}
  .top-right{align-items:flex-start;}
  .lang-row{justify-content:flex-start;}
  .actions-grid{justify-content:start;}
}

    /* ===== TOP BAR ===== */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
      margin-bottom:24px;
    }

    .right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:10px;
      
    }

    .lang,.actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .lang a{
      padding:6px 10px;
      border-radius:10px;
      text-decoration:none;
      color:#111;
      font-weight:600;
      border:1px solid #e5e7eb;
      background:#fff;
    }
    .lang a.active{background:#eef2ff;border-color:#c7d2fe}

    .btn-outline{
      padding:8px 12px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#fff;
      text-decoration:none;
      font-weight:700;
      color:#111;
    }

    /* ===== CARDS ===== */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:18px;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
    }

    .kpi{
      font-size:30px;
      font-weight:900;
    }

    .profit{color:#16a34a}

    /* ===== FORM ===== */
    .form-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:12px;
    }

    input,button{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      font-size:14px;
    }

    button{
      background:var(--primary);
      color:#fff;
      border:none;
      font-weight:800;
      cursor:pointer;
    }

    .btn-outline{
  border:1px solid var(--line);
  background:#fff;
  padding:8px 12px;
  border-radius:999px;
  font-weight:800;
  font-size:14px;
  text-decoration:none;
  color:inherit;
}
.btn-outline:hover{
  border-color:var(--primary);
  box-shadow:0 0 0 2px rgba(37,99,235,.10) inset;
}

    .note{margin-top:8px;color:var(--muted);font-size:13px}

    /* ===== TABLE ===== */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}

    /* ===== CHART ===== */
    canvas{width:100%!important;height:320px!important}
  </style>
</head>

<body>
<div class="wrap">

  <!-- ===== TOP ===== -->
<div class="topbar">
  <div class="top-left">
    <h1 style="margin:0;">{{ t.get("title","ProfitApp") }}</h1>
    <p class="sub" style="margin:8px 0 0 0;">{{ t.get("subtitle","") }}</p>
    <div style="margin-top:10px;font-weight:700;">
      üëã {{ t.get("welcome","Welcome") }}, {{ current_user.username }}
    </div>
  </div>

  <div class="top-right">
    <!-- LANG -->
    <div class="lang-row">
      <a class="pill {{ 'active' if lang=='tr' else '' }}" href="{{ url_for('index', lang='tr', all=('1' if show_all else None)) }}">üáπüá∑ T√ºrk√ße</a>
      <a class="pill {{ 'active' if lang=='sv' else '' }}" href="{{ url_for('index', lang='sv', all=('1' if show_all else None)) }}">üá∏üá™ Svenska</a>
      <a class="pill {{ 'active' if lang=='en' else '' }}" href="{{ url_for('index', lang='en', all=('1' if show_all else None)) }}">üá¨üáß English</a>
    </div>

    <!-- ACTIONS -->
    <div class="actions-grid">
      <a class="btn-outline" href="{{ url_for('export_csv', lang=lang, all=('1' if show_all else None), start=start, end=end) }}">‚¨áÔ∏è CSV</a>
      <a class="btn-outline" href="{{ url_for('export_xlsx', lang=lang, all=('1' if show_all else None), start=start, end=end) }}">‚¨áÔ∏è Excel</a>

      {% if show_all %}
        <a class="btn-outline" href="{{ url_for('index', lang=lang, all='1') }}">{{ t.get("all_records","All records") }}</a>
        <a class="btn-outline" href="{{ url_for('admin_users', lang=lang) }}">{{ t.get("manage_users","Manage users") }}</a>
      {% endif %}

      {{ t.get("download_csv","Download CSV") }}
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
      <!-- Export -->
      <a class="btn-outline"
         href="{{ url_for('export_csv', lang=lang, all=('1' if show_all else None), start=start, end=end) }}">
        ‚¨áÔ∏è CSV
      </a>

      <a class="btn-outline"
         href="{{ url_for('export_xlsx', lang=lang, all=('1' if show_all else None), start=start, end=end) }}">
        ‚¨áÔ∏è Excel
      </a>

      <!-- Range filter -->
      <a class="btn-outline"
         href="{{ url_for('index', lang=lang, range='30', all=('1' if show_all else None)) }}">
        30
      </a>
      <a class="btn-outline"
         href="{{ url_for('index', lang=lang, range='90', all=('1' if show_all else None)) }}">
        90
      </a>
      <a class="btn-outline"
         href="{{ url_for('index', lang=lang, range='365', all=('1' if show_all else None)) }}">
        365
      </a>
      <a class="btn-outline"
         href="{{ url_for('index', lang=lang, all=('1' if show_all else None)) }}">
        {{ t.get("all","T√ºm√º") }}
      </a>

      <!-- Logout -->
      <a class="btn-outline" href="{{ url_for('logout', lang=lang) }}">
        {{ t.get("logout","Logout") }}
      </a>
    </div>
  </div>
</div>

<!-- ===== KPI ===== -->
<div class="grid">
  <div class="card">
    <div>{{ t.get("total_sales","Toplam satƒ±≈ü") }}</div>
    <div class="kpi">{{ total_sales }} {{ currency }}</div>
  </div>
  <div class="card">
    <div>{{ t.get("total_expense","Toplam gider") }}</div>
    <div class="kpi">{{ total_expense }} {{ currency }}</div>
  </div>
  <div class="card">
    <div>{{ t.get("total_profit","Toplam k√¢r") }}</div>
    <div class="kpi profit">{{ total_profit }} {{ currency }}</div>
  </div>
</div>

<!-- ===== FORM ===== -->
  <div class="card" style="margin-top:20px">
    <h3>{{ t.get("new_record","Yeni kayƒ±t") }}</h3>
    <form method="post" action="{{ url_for('index_post', lang=lang) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="form-grid">
        <input type="date" name="day" required>
        <input type="number" step="0.01" name="sales" placeholder="{{ t.get('sales','Satƒ±≈ü') }}" required>
        <input type="number" step="0.01" name="expense" placeholder="{{ t.get('expense','Gider') }}" required>
        <button>{{ t.get("save","Kaydet") }}</button>
      </div>
    </form>
    <div class="note">{{ t.get("profit_note","Not: K√¢r otomatik = satƒ±≈ü - gider") }}</div>
  </div>

<!-- ===== TABLE ===== -->
<div class="card" style="margin-top:20px">
  <h3>{{ t.get("records_title","Kayƒ±tlar (son 50)") }}</h3>

  <table>
    <thead>
      <tr>
        {% if show_all %}
          <th>{{ t.get("user","Kullanƒ±cƒ±") }}</th>
        {% endif %}
        <th>{{ t.get("date","Tarih") }}</th>
        <th>{{ t.get("sales","Satƒ±≈ü") }}</th>
        <th>{{ t.get("expense","Gider") }}</th>
        <th>{{ t.get("profit","K√¢r") }}</th>
        <th>{{ t.get("actions","ƒ∞≈ülem") }}</th>
      </tr>
    </thead>

    <tbody>
      {% for r in rows %}
      <tr>
        {% if show_all %}
          <td>{{ r["username"] }}</td>
        {% endif %}

        <td>{{ r["day"] }}</td>
        <td>{{ "%.2f"|format(r["sales"]) }} {{ currency }}</td>
        <td>{{ "%.2f"|format(r["expense"]) }} {{ currency }}</td>
        <td>{{ "%.2f"|format(r["profit"]) }} {{ currency }}</td>

        <td style="white-space:nowrap;">
          <a href="{{ url_for('edit_record', record_id=r['id'], lang=lang) }}"
             title="{{ t.get('edit','D√ºzenle') }}"
             style="margin-right:10px;">‚úèÔ∏è</a>

          <form method="post"
                action="{{ url_for('delete_record', record_id=r['id'], lang=lang) }}"
                style="display:inline"
                onsubmit="return confirm('{{ t.get('confirm_delete','Silinsin mi?') }}')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit"
                    title="{{ t.get('delete','Sil') }}"
                    style="border:none;background:none;cursor:pointer;padding:0;">
              üóëÔ∏è
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

  <!-- ===== CHARTS ===== -->
  <div class="grid" style="margin-top:20px">
    <div class="card"><canvas id="dailyChart"></canvas></div>
    <div class="card"><canvas id="monthlyChart"></canvas></div>
  </div>

</div>

<script>
const dailyRows = {{ daily_rows|tojson }};
const monthlyRows = {{ monthly_rows|tojson }};

new Chart(dailyChart,{
  type:'bar',
  data:{
    labels:dailyRows.map(x=>x.day),
    datasets:[
      {label:'{{ t.get("sales","Satƒ±≈ü") }}',data:dailyRows.map(x=>x.sales)},
      {label:'{{ t.get("expense","Gider") }}',data:dailyRows.map(x=>x.expense)},
      {label:'{{ t.get("profit","K√¢r") }}',data:dailyRows.map(x=>x.profit),type:'line'}
    ]
  }
});

new Chart(monthlyChart,{
  type:'bar',
  data:{
    labels:monthlyRows.map(x=>x.month),
    datasets:[
      {label:'{{ t.get("sales","Satƒ±≈ü") }}',data:monthlyRows.map(x=>x.sales)},
      {label:'{{ t.get("expense","Gider") }}',data:monthlyRows.map(x=>x.expense)},
      {label:'{{ t.get("profit","K√¢r") }}',data:monthlyRows.map(x=>x.profit),type:'line'}
    ]
  }
});
</script>
</body>
</html>